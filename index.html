<script>
  // ... keep your existing constants and variables ...

  async function getRearStream() {
    const base = { width: { ideal: 1920 }, height: { ideal: 1080 } };
    const gum = (extra = {}) =>
      navigator.mediaDevices.getUserMedia({
        video: { ...base, ...extra },
        audio: false,
      });

    // 1) Strongest hint
    try {
      return await gum({ facingMode: { exact: "environment" } });
    } catch {}

    // 2) Softer hint
    try {
      return await gum({ facingMode: { ideal: "environment" } });
    } catch {}

    // 3) Enumerate devices (labels need prior permission on most phones)
    let tempStream = null;
    try {
      tempStream = await gum({ facingMode: { ideal: "user" } });
    } catch {}
    let devices = [];
    try {
      devices = await navigator.mediaDevices.enumerateDevices();
    } finally {
      if (tempStream) tempStream.getTracks().forEach((t) => t.stop());
    }

    const videoIns = devices.filter((d) => d.kind === "videoinput");
    const rearish = videoIns.find((d) =>
      /back|rear|environment/i.test(d.label)
    );
    if (rearish) {
      return await navigator.mediaDevices.getUserMedia({
        video: { deviceId: { exact: rearish.deviceId }, ...base },
        audio: false,
      });
    }

    // 4) Heuristic: last camera is often the back camera
    if (videoIns.length > 1) {
      return await navigator.mediaDevices.getUserMedia({
        video: {
          deviceId: { exact: videoIns[videoIns.length - 1].deviceId },
          ...base,
        },
        audio: false,
      });
    }

    // 5) Final fallback
    return await gum();
  }

  async function start() {
    document.getElementById("start").style.display = "none";
    try {
      const stream = await getRearStream();
      src.srcObject = stream;
      await src.play();
    } catch (e) {
      console.error(e);
      alert(
        "Rear camera failed. Check HTTPS & camera permission.\n\n" + e.message
      );
      return;
    }

    // ... keep the rest of your producer/consumer code unchanged ...
  }

  document.getElementById("start").textContent = "Start rear camera (0.5Ã—)";
  document.getElementById("start").addEventListener("click", start);
</script>
